# Capacity Hints и метаданные (QA)

Кратко: `h2k.capacityHint` в `.avsc` подсказывает ожидаемое число полей Avro‑payload. Значение используется для подбора ёмкости буфера строк и для диагностических предупреждений, чтобы снизить аллокации на горячем пути.

---

## Что именно считать в hint

Итоговое число полей в Avro payload для «типичной» строки складывается из:
```
CAPACITY_HINT =
  N(CF)                 // колонки из выбранных CF, которые обычно не NULL
+ N(PK)                 // колонки первичного ключа — ВСЕГДА присутствуют в payload
+ (has _event_ts      ? 1 : 0)
+ (has _delete        ? 1 : 0)
+ (has _wal_seq       ? 1 : 0)
+ (has _wal_write_time ? 1 : 0)
```

### Почему так
- **CF**: считаем только те колонки целевых CF, которые реально приходят не‑NULL в типичном кейсе (лучше ориентироваться на **P95**, а не на абсолютный максимум).
- **PK всегда в payload** — независимо от настроек CF (свойство `"h2k.cf.list"` в `.avsc`).
- **Метаполя** добавляются только если соответствующие поля объявлены в `.avsc`.
- **Salt (Phoenix)** не добавляет полей в payload — это префикс в rowkey; он влияет на парсинг, а не на количество полей.

---

## Служебные поля Avro (опционально)

Если поля присутствуют в схеме, endpoint заполняет их автоматически:
- `_event_ts` — максимальная метка времени среди ячеек;
- `_delete` — `true`, если в строке был delete‑маркер;
- `_wal_seq` — sequence id записи в WAL;
- `_wal_write_time` — время записи WAL в миллисекундах epoch.

---

## QA‑пример: `TBL_JTI_TRACE_CIS_HISTORY`

По `.avsc` и факту на QA:
- Всего колонок в таблице (включая `PK: c, t, opd`) — **32** → это и есть базовый payload без служебных полей.
- `N(PK) = 3` (всегда в payload, даже если CF не содержит этих колонок явно).

Расчёты:

- **Базовый payload (без служебных полей)**:  
  `hint = 32`.

- **Если в схеме есть `_event_ts` и `_delete`**:  
  `hint = 32 + 2 = 34`.

- **Если добавлены `_event_ts`, `_delete`, `_wal_seq`, `_wal_write_time`**:  
  `hint = 32 + 4 = 36`.

---

## Где задавать значение

`h2k.capacityHint` задаётся **только** в Avro‑схеме:

```json
{
  "type": "record",
  "name": "TBL_JTI_TRACE_CIS_HISTORY",
  "h2k.capacityHint": 32,
  ...
}
```

---

## Как быстро проверить (на реальном потоке QA)

Выведите несколько сообщений через Confluent Avro consumer и оцените число ключей:

```bash
kafka-avro-console-consumer \
  --bootstrap-server 10.254.3.111:9092,10.254.3.112:9092,10.254.3.113:9092 \
  --topic TBL_JTI_TRACE_CIS_HISTORY --from-beginning --max-messages 200 \
  --property schema.registry.url=http://10.254.3.111:8081 \
| jq -c 'keys|length' \
| sort -n | uniq -c
```

- Ориентируйтесь на **P95–P99** по числу ключей, а не на единичные пики.
- Если часто видите значение больше hint — поднимите hint на ближайшую «круглую» величину.

---

## Пассивные рекомендации от эндпоинта

- Репликационный поток автоматически копит максимум полей по каждой таблице.
- После накопления ≈200 строк и превышения текущего `h2k.capacityHint` в логах появится предупреждение уровня `WARN`:
  `Таблица ns:cap: замечено 42 полей в строке, подсказка capacityHint=32 (источник: Avro-схема). Рекомендуется обновить Avro-схему.`
- В сообщении указан источник подсказки, поэтому видно, где нужно актуализировать значение.
- Рекомендация повторяется только при росте фактического максимума — спама в логах не будет.

---

## Чек‑лист

- [ ] Указан hint для «широких» таблиц (обычно ≥ 16 полей).
- [ ] Включены в расчёт `PK` (они всегда в payload).
- [ ] Учтены служебные поля, если они добавлены в `.avsc`.
- [ ] Значение ориентировано на **P95**, а не на max.
- [ ] Значение зафиксировано в `.avsc` и проверено на реальном потоке.

---

Корректные `h2k.capacityHint` снижают аллокации и паузы GC, повышая стабильность и скорость репликации на QA/PROD.
